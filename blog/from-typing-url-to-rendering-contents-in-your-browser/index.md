---
title: "URL入力⇨ブラウザに表示まで"
path: "from-typing-url-to-rendering-contents-in-your-browser"
date: "2022-02-11"
update: ""
hero_image: "./alina-grubnyak-ZiQkhI7417A-unsplash.jpg"
hero_image_alt: "network"
hero_image_credit_text: "Alina Grubnyak"
hero_image_credit_link: "https://unsplash.com/photos/ZiQkhI7417A"
tags: [infra,network,web]
---

## 動機
だいぶ擦られたお題ではあるのですが、、、
去年基本情報＆応用情報を受験して、4月にネットワークスペシャリストを受験してみる予定です。
そのために、「[ネットワークはなぜ繋がるのか 第二版](https://www.amazon.co.jp/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AF%E3%81%AA%E3%81%9C%E3%81%A4%E3%81%AA%E3%81%8C%E3%82%8B%E3%81%AE%E3%81%8B-%E7%AC%AC2%E7%89%88-%E7%9F%A5%E3%81%A3%E3%81%A6%E3%81%8A%E3%81%8D%E3%81%9F%E3%81%84TCP-IP%E3%80%81LAN%E3%80%81%E5%85%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%90%E3%81%AE%E5%9F%BA%E7%A4%8E%E7%9F%A5%E8%AD%98-%E6%88%B8%E6%A0%B9/dp/4822283119)」や「[マスタリングTCP/IP 入門編](https://www.amazon.co.jp/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0TCP-IP%E2%80%95%E5%85%A5%E9%96%80%E7%B7%A8%E2%80%95-%E7%AC%AC6%E7%89%88-%E4%BA%95%E4%B8%8A-%E7%9B%B4%E4%B9%9F/dp/4274224473/ref=sr_1_1?keywords=tcp%2Fip&qid=1644243733&s=books&sprefix=TCP%2Cstripbooks%2C167&sr=1-1)」などを読んでみたり、いわゆる試験対策の参考書である「[徹底攻略 ネットワークスペシャリスト教科書](https://www.amazon.co.jp/%E5%BE%B9%E5%BA%95%E6%94%BB%E7%95%A5-%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%82%B7%E3%83%A3%E3%83%AA%E3%82%B9%E3%83%88%E6%95%99%E7%A7%91%E6%9B%B8-%E4%BB%A4%E5%92%8C4%E5%B9%B4%E5%BA%A6-%E5%BE%B9%E5%BA%95%E6%94%BB%E7%95%A5%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-%E6%A0%AA%E5%BC%8F%E4%BC%9A%E7%A4%BE%E3%82%8F%E3%81%8F%E3%82%8F%E3%81%8F%E3%82%B9%E3%82%BF%E3%83%87%E3%82%A3%E3%83%AF%E3%83%BC%E3%83%AB%E3%83%89-ebook/dp/B09DK5MZXJ/ref=sr_1_2_sspa?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&crid=2ENBSDXHJDVYG&keywords=%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%82%B7%E3%83%A3%E3%83%AA%E3%82%B9%E3%83%88+%E6%95%99%E7%A7%91%E6%9B%B8&qid=1644243967&sprefix=%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%82%B7%E3%83%A3%E3%83%AA%E3%82%B9%E3%83%88+%E6%95%99%E7%A7%91%E6%9B%B8%2Caps%2C197&sr=8-2-spons&psc=1&spLa=ZW5jcnlwdGVkUXVhbGlmaWVyPUExVjBEOVVPTElKV1RKJmVuY3J5cHRlZElkPUEwODQwOTEyMUpUNUkwWlowNDJCTyZlbmNyeXB0ZWRBZElkPUExQzlWMEtWREhZS1FFJndpZGdldE5hbWU9c3BfYXRmJmFjdGlvbj1jbGlja1JlZGlyZWN0JmRvTm90TG9nQ2xpY2s9dHJ1ZQ==)」を読んでみたりしました。

せっかく勉強するからには、試験対策のためだけの勉強ではなく、実際に役に立つ知識＆教養を身につけたいと思い、過去問やり込みなどはギリギリまで行わない予定なのですが、勉強を進めて知っていることが増えていくに従い、詳細に気を取られ全体が見えなくなってきてしまっていました。

そこで、複数書籍を読んで、どんな知識が全体を通してあるのかなんとなくわかってきたところで「木を見て森を見ず」な状態を脱却するために一度全体の大きな流れを掴んでから、再度詳細を勉強した方が効率が良いのではないかと思いました。
そのため今回は**「URLがアドレスバーに入力されてからWebページが表示されるまで」**の流れをまとめていこうと思います。

## 構成
### ブラウザ⇨サーバーに届くまで
- URL解析
- リクエストメッセージ作成
- プロトコルスタックでの処理
  - DNSサーバー問い合わせ
  - TCPコネクション確立
  - IP⇨LANアダプタにデータを渡す
- LANアダプタがデジタル⇨アナログ変換＆ルーターへ信号送信
- ルーター間を伝わっていく
- サーバーに届く

### サーバーがデータの受信⇨ブラウザがコンテンツを表示するまで
- サーバーが信号を受信する
  - ブラウザがデータ送信の際にとったアクションの逆
  - 信号から元のリクエストメッセージまで戻す
- サーバーアプリケーションがデータを受け取る
  - URI、HTTPメソッドなどの情報をもとに処理
- サーバーがレスポンスメッセージを作成してブラウザに送り返す
- ブラウザが信号を受信する
  - サーバーの受信動作と同じ
  - 信号から元のレスポンスメッセージまで戻す
- レスポンスヘッダーを確認して、必要であればコンテンツを処理
- （HTMLの場合）HTMLファイルを解析してOSにブラウザに表示するよう指示を出す
- （画像などがアル場合）画像ファイルを再度サーバーにリクエストする。
  - レスポンスが返ってきたら、再度OSに指示を出しブラウザに表示

<br/>
今回は、この順番でまとめていければと思います。

いきなり詳細に入ってしまうと、項目が多すぎて全体の流れの中でどこにいるのかがわからなくなってしまうので、最初に全体の流れを記載しました。詳細を読む中で、全体のどこにいるのかがわからなくなったら、再度この構成を見ていただければとお思います。

また、かといって大枠だけだと流石に中身がなさすぎるので、程よい塩梅を狙ってまとめていければと思います。

＊本来各大項目毎に本が何冊も書けるレベルで情報量が多いはずなので、今回はわかりやすくシンプルにするために、プロバイダが提供してくれているルーター＆ルーター間のやりとりは大幅に省いております。

## URL解析
アドレスバーにはURLではない検索文字列を打ち込むこともできるし、URLを打ち込むこともできます。そのため、まずはアドレスバーに打ち込まれた文字列を解析して、URLであれば続く処理を、文字列であれば検索ブラウザを呼び出す処理をしていきます。

実際にURLが打ち込まれた例を考えていきましょう。

[https://blog.shgnkn.io/from-typing-url-to-rendering-contents-in-your-browser/](https://blog.shgnkn.io/from-typing-url-to-rendering-contents-in-your-browser) という、このブログのURLがあります。このURL文字列は複数の要素で成り立っており、ブラウザ内部では以下のように分解されます。

`https:` プロトコルを表します。

`//` 後に続く文字列がサーバーの名前であることを表します。

`blog.shgnkn.io` サーバー名です。

`/from-typing-url-to-rendering-contents-in-your-browser/` データがあるパス名です。

<br/>
これらの情報をもとに、HTTPリクエストを作成したり、必要に応じて暗号処理モジュールを呼び出して暗号化をしたりしていきます。

また、この際に、対象リソースのキャッシュをブラウザが保有しており、サーバーにHTTPリクエストを送信する必要がない場合には、以下の手順は飛ばしてブラウザへのレンダリングを開始することができます。

## HTTPリクエストメッセージの作成
URLの解析が完了して、サーバーへの問い合わせが必要なことがわかったら、次はHTTPリクエストメッセージを作成していきます。

リクエストメッセージにはルールが決められており、それに従ってブラウザは以下のような形式のリクエストメッセージを作成していきます。

```
POST / /sample/samle.php HTTP / 1.1
・
・
・
<空白行>
<メッセージボディ>
```

最初の行がリクエストヘッダで、どのメソッドをどのリソースに対してどんなプロトコルでリクエストを出したいのか指定します。
その後複数行のメッセージヘッダーで、コンテンツの種類や圧縮の形式など、必要な情報を付与していきます。
メソッドがPOSTの場合には、メッセージヘッダーの後に１行空白行を開けてからメッセージボディが続きます。ここには、`/sample/samle.php`に渡したいデータなどを記載します。

リクエストメッセージのルールについて、詳しくはMDNの[HTTP メッセージ](https://developer.mozilla.org/ja/docs/Web/HTTP/Messages)をご確認ください。

## プロトコルスタックでの処理
ブラウザはURLを解析して、HTTPリクエストメッセージを作成することまでできますが、メッセージをサーバーに向けて送信する機能は持ち合わせていません。

そのため、作成したメッセージをサーバーに向けて送信する作業はOSに依頼していきます。

OSが依頼を受け取ってからは、TCP/IPなどさまざまなプロトコルが共同で作業をしていくことになります。

全体の流れとしてはOSI参照モデルに沿って順番にデータが流れていくのですが、一部階層の異なるプロトコルが互いにやりとりをして進む処理もあるため、今回のまとめでは厳密に切り分けずに進めていきたいと思います。

### DNSサーバーへの問い合わせ
URLを解析して、宛先ドメインはわかりましたが、宛先IPアドレスはまだわかっていません。

ただし、ブラウザがドメインとIPアドレスのペアをキャッシュとして保有している場合には、DNSサーバーに問い合わせする必要がなくなるので、以下のプロセスは不要になります。

ブラウザがキャッシュを保有していない場合には、DNSサーバーと通信してドメインからIPアドレスに変換する必要があります。

その際に、DNSサーバーとの通信を実際に行うのが、SocketライブラリのDNSリゾルバです。イメージとしては、今回まとめているブラウザとサーバーの関係がDNSリゾルバとDNSとで成り立っていると考えていただけると分かりやすいかと思います。
Socketライブラリについて少し補足すると、SocketライブラリはOSに組み込まれているネットワークと通信するためのライブラリです。

DNSリゾルバがDNSに問い合わせを行い、ドメインからIPアドレスを取得するのですが、実際の通信はDNSリゾルバではなく、OS組み込みのプロトコル・スタックが行います。DNSリゾルバがリクエストメッセージを作成しDNSサーバーへの問い合わせをプロトコル・スタックに依頼するイメージです。

また、この際に「DNSサーバーのIPアドレスはどうやって調べるんだ？」という疑問が出るかと思うのですが、DNSサーバーのIPアドレスは、PCのTCP/IPの設定であらかじめ設定してあるので、特にどこかに問い合わせたりする必要がないのです。

ちなみに、DNSサーバーへの問い合わせはTCPではなくUDPで行われます。なぜなら、問い合わせに使うパケットは１つしかないので、万が一通信に失敗してもDNSサーバーからのレスポンスが返って来なかったら失敗と判断することが可能で、わざわざ面倒な接続手続きをしてTCPを活用するよりも効率が良いからです。

DNSサーバーは階層構造で世界中にたくさんあるので、自分が問い合わせしたドメインのIPアドレスが格納されているDNSサーバーに問い合わせるまでにはもう少し道のりがあるのですが、今回は簡略化のために詳細は割愛します。

### TCPコネクションの確立
宛先IPアドレスがわかったら、次は実際にサーバーに向けてHTTPリクエストメッセージを送信するための準備をしていきます。
ここでも、DNSサーバーに問い合わせを行った時のように、Socketライブラリを活用してOSのプロトコル・スタックを呼び出して実際の処理を行っていきます。

イメージとしては、データを流すためのパイプラインを通信の最初に確立して、そこにデータを流していくイメージです。
流れとしては、
- サーバーとクライアント双方でそれぞれソケットを作成する
- クライアント側のソケットからからサーバー側のソケットにパイプを伸ばす
- 実際のデータ送受信を行う
- 最後にパイプを外す

という流れになります。それぞれ詳細を見ていきます。

#### ソケット作成
ソケットは実態を持っているわけではなく、宛先IPアドレス、送信元IPアドレス、ポート番号などを保持しているメモリ領域にすぎません。
プロトコル・スタックはこれらの情報を確認して、どの宛先に対してデータを送信するのかなどを把握しています。

このメモリ領域が、サーバー側のソケットに関してはサーバーを立ち上げた際に確保されるようになっていて、クライアント側のソケットに関しては


e